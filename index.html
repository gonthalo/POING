<!doctype html>
<html>
<head>
	<title>POING 2</title>
	<style type="text/css">
		a {
			color: black;
			border-radius: 4px;
			border:2px solid #00d070;
		}
		a:hover {
			background-color: #00d070;
		}
	</style>
</head>
<body>
	<h2 align="center">En este lugar se encuentra la suprema Verdad:</h2>
	<div style="margin-left: 70px; margin-right: 70px;">
		<div style="text-align:center">
			<input type="button" onclick="comenzar();" value="Comenzar de nuevo" style="border-radius:4px">
			N&uacute;mero de part&iacute;culas:
			<input id="puntitos" type="number" min="1" max="8" value="4">
		</div>
		<canvas id="lienzo" height="500px" width="1200px" style="border:2px solid #00d070;">
			Your browser does not support the HTML5 canvas tag.
		</canvas>
		<div>
			<h3 align="center" text-align="center"><a href="http://gonthalo.github.io/POING/instructions.html">&iquest;Carece usted de los conocimientos necesarios para interpretarla?</a></h3>
		</div>
	</div>
	<script type="text/javascript" lenguage="javascript">
var lienzo = document.getElementById("lienzo");
var pluma = lienzo.getContext("2d");
var pars = [];
var mapa = [];
var g = 0;
var numpars = 3;
var magnet=0;
var wallx=true;
var wally=true;
var ymax=500;
var xmax=1200;
var bacolor = "beige";

function pot(base, expo){
	var res=1;
	for (var i = 0; i < expo; i++) {
		res = res*base;
	}
	return res;
}

function dist(a, b){
	if (a==-1){
		return Math.sqrt(pot(jugador.x-pars[b].x, 2)+pot(jugador.y-pars[b].y, 2));
	}
	return Math.sqrt(pot(pars[a].x-pars[b].x, 2)+pot(pars[a].y-pars[b].y, 2));
}

function choque(i1, i2){
	if (i1==-1 || i2==-1){

	}
	pars[i1].x = (pars[i1].x*pars[i1].m + pars[i2].x*pars[i2].m)/(pars[i1].m + pars[i2].m);
	pars[i1].y = (pars[i1].y*pars[i1].m + pars[i2].y*pars[i2].m)/(pars[i1].m + pars[i2].m);
	pars[i1].vx = (pars[i1].vx*pars[i1].m + pars[i2].vx*pars[i2].m)/(pars[i1].m + pars[i2].m);
	pars[i1].vy = (pars[i1].vy*pars[i1].m + pars[i2].vy*pars[i2].m)/(pars[i1].m + pars[i2].m);
	pars[i1].q = pars[i1].q + pars[i2].q;
	pars[i1].m = pars[i1].m + pars[i2].m;
	pars.splice(i2, 1);
	numpars--;
}

function Jugador() {
	this.m = 5;
	this.q = Math.floor(Math.random()*3) - 1;
	this.x = Math.random()*1160 + 20;
	this.y = Math.random()*460 + 20;
	this.vx = Math.random()*6 - 3;
	this.vy = Math.random()*6 - 3;
	this.num = -1;
}

Jugador.prototype.mover = function() {
	this.x = this.x + this.vx;
	this.y = this.y + this.vy;
	if (this.x>xmax - 20 || this.x<20){
		if (wallx){
			this.vx = 0-this.vx;
		} else {
			this.x = (this.x + xmax)%xmax;
		}
	}
	if (this.y>ymax - 20 || this.y<20){
		if (wally){
			this.vy = 0-this.vy;
		} else {
			this.y = (this.y + ymax)%ymax;
		}
	}
	if (this.y<ymax - 20){
		this.vy = this.vy + g;
	}
	this.vy = this.vy + 0.3*this.q*magnet*this.vx/this.m;
	this.vx = this.vx - 0.3*this.q*magnet*this.vy/this.m;
	for (var i = 0; i < numpars; i++) {
		if (dist(this.num, i)>Math.sqrt(20*this.m)){
			this.vy = this.vy - (pars[i].y-this.y)*950*pars[i].q*this.q/pot(dist(this.num, i),3)/this.m;
			this.vx = this.vx - (pars[i].x-this.x)*950*pars[i].q*this.q/pot(dist(this.num, i),3)/this.m;
			this.vy = this.vy + (pars[i].y-this.y)*90*pars[i].m/pot(dist(this.num, i),3);
			this.vx = this.vx + (pars[i].x-this.x)*90*pars[i].m/pot(dist(this.num, i),3);
		}
	}
};

Jugador.prototype.entrada = function jugador_entrada(keyCode) {
	if(keyCode == 87 && this.vy > -15) {
		this.vy = this.vy - 1;
	}
	if(keyCode == 65 && this.vx > -15) {
		this.vx = this.vx - 1;
	}
	if(keyCode == 68 && this.vx < 15) {
		this.vx = this.vx + 1;
	}
	if(keyCode == 83 && this.vy < 15) {
		this.vy = this.vy + 1;
	}
	if(keyCode == 69){
		this.vy = 0;
		this.vx = 0;
	}
	if(keyCode == 67){
		this.y = ymax/2;
		this.x = xmax/2;
	}
};

Jugador.prototype.dibujar = function () {
	pluma.fillStyle = bacolor;
	pluma.fillRect(0, 0, xmax, ymax);
	pluma.fillStyle = "black";
	pluma.font = "20px Times"
	pluma.fillText("m = ", 20, 30);
	pluma.fillText(this.m, 60, 30);
	pluma.fillText("Q = ", 20, 50);
	pluma.fillText(this.q, 60, 50);
	var i;
	pluma.strokeStyle = "black";
	pluma.beginPath();
	for (i=1; i<10; i=i + 1.4){
		pluma.arc(this.x,this.y,i,0,2*Math.PI);
	}
	pluma.stroke();
};

function Par() {
	this.m = Math.random()*4 + 1;
	this.q = Math.floor(Math.random()*3) - 1;
	this.x = Math.random()*(xmax - 40) + 20;
	this.y = Math.random()*(ymax - 40) + 20;
	this.vx = Math.random()*6 - 3;
	this.vy = Math.random()*6 - 3;
	this.num = -1;
}

Par.prototype.mover = function() {
	this.x = this.x + this.vx;
	this.y = this.y + this.vy;
};

Par.prototype.calcu = function() {
	if (this.x>xmax - 20 || this.x<20){
		if (wallx){
			this.vx = 0-this.vx;
		} else {
			this.x = (this.x + xmax)%xmax;
		}
	}
	if (this.y>ymax - 20 || this.y<20){
		if (wally){
			this.vy = 0-this.vy;
		} else {
			this.y = (this.y + ymax)%ymax;
		}
	}
	if (this.y<ymax - 20){
		this.vy = this.vy + g;
	}
	this.vy = this.vy + 0.3*this.q*magnet*this.vx/this.m;
	this.vx = this.vx - 0.3*this.q*magnet*this.vy/this.m;
	for (var i = 0; i < numpars; i++) {
		if (this.num!=i){
			if (dist(this.num, i)>Math.sqrt(20*this.m)){
				this.vy = this.vy - (pars[i].y-this.y)*950*pars[i].q*this.q/pot(dist(this.num, i),3)/this.m;
				this.vx = this.vx - (pars[i].x-this.x)*950*pars[i].q*this.q/pot(dist(this.num, i),3)/this.m;
				this.vy = this.vy + (pars[i].y-this.y)*90*pars[i].m/pot(dist(this.num, i),3);
				this.vx = this.vx + (pars[i].x-this.x)*90*pars[i].m/pot(dist(this.num, i),3);
			} else {
				//choque(this.num, i);
			}
		}
	}
	if (dist(-1, this.num)>Math.sqrt(20*this.m)){
		this.vy = this.vy - (jugador.y-this.y)*950*jugador.q*this.q/pot(dist(jugador.num, this.num),3)/this.m;
		this.vx = this.vx - (jugador.x-this.x)*950*jugador.q*this.q/pot(dist(jugador.num, this.num),3)/this.m;
		this.vy = this.vy + (jugador.y-this.y)*90*jugador.m/pot(dist(jugador.num, this.num),3);
		this.vx = this.vx + (jugador.x-this.x)*90*jugador.m/pot(dist(jugador.num, this.num),3);
	}
};

Par.prototype.dibujar = function () {
	pluma.fillStyle = "black";
	if (this.q > 0){
		pluma.fillStyle="red";
	}
	if (this.q < 0){
		pluma.fillStyle="blue";
	}
	pluma.beginPath();
	pluma.arc(this.x,this.y,Math.sqrt(20*this.m),0,2*Math.PI);
	pluma.fill();
};

function comenzar() {
	pars = [];
	numpars = document.getElementById("puntitos").value - 1;
	var n;
	for (n=0; n<240; ++n){
		mapa [n] = Math.floor(Math.random()*8);
	}
	for (n=0; n<numpars; ++n){
		pars[n] = new Par();
		pars[n].num = n;
	}
	jugador = new Jugador();
}

function jugar() {
	jugador.dibujar();
	for (var i=0; i<numpars; i++){
		pars[i].dibujar();
	}
	jugador.mover();
	for (var i=0; i<numpars; i++){
		pars[i].mover();
		pars[i].calcu();
	}
}

window.addEventListener("keydown", function(event) {
	jugador.entrada(event.keyCode);
	if (event.keyCode == 71) {
		g = 1 - g;
	}
	if (event.keyCode == 82) {
		magnet = 1;
		bacolor = "pink";
	}
	if (event.keyCode == 76) {
		magnet = -1;
		bacolor = "LightBlue";
	}
	if (event.keyCode == 79) {
		magnet = 0;
		bacolor = "beige";
	}
	if (event.keyCode == 89) {
		wallx = !wallx;
	}
	if (event.keyCode == 88) {
		wally = !wally;
	}
});

comenzar();

window.setInterval(jugar, 25);
	</script>
</body>
